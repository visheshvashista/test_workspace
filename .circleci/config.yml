# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Use a package of configuration called an orb.

jobs:
  create_inventory:
    docker:
      - image: amazon/aws-cli
    steps:
      - checkout 
      - run:
          name: Install dependencies
          command: |
            yum install -y tar gzip     
      - run:
          name: Add back-end ip to ansible inventory and upload dnsname to memstash
          command: |
            echo "[web]" > .circleci/ansible/inventory.txt
            aws ec2 describe-instances \
              --query 'Reservations[*].Instances[*].PublicIpAddress' \
              --output text >> .circleci/ansible/inventory.txt
            aws ec2 describe-instances  --query 'Reservations[*].Instances[*].PublicDNSName' --output text
            export dnsname="$(aws ec2 describe-instances  --query 'Reservations[*].Instances[*].PublicDNSName' --output text)"
             
            echo 1
            echo AWT-${dnsname}-7
             
            # save servername to memstash
            curl -H "Content-Type: text/plain" -H "token: vvv-udapeople-${CIRCLE_WORKFLOW_ID}" --request PUT --data "$dns" https://api.memstash.io/values/dnsname
            DNSNAME=$(curl -H "token: API_URL-${CIRCLE_WORKFLOW_ID}" --request GET https://api.memstash.io/values/dnsname)
            echo $DNSNAME
            exit 1
workflows:
  default:
    jobs:
      - create_inventory 